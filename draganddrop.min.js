!function(a){"use strict";function e(){return"ondrag"in document.createElement("a")}function n(a){a.originalEvent&&(a.dataTransfer=a.originalEvent.dataTransfer),"undefined"!=typeof a.dataTransfer&&"none"===a.dataTransfer.dropEffect&&("copy"===a.dataTransfer.effectAllowed||"move"===a.dataTransfer.effectAllowed?a.dataTransfer.dropEffect=a.dataTransfer.effectAllowed:"copyMove"!==a.dataTransfer.effectAllowed&&"copymove"!==a.dataTransfer.effectAllowed||(a.dataTransfer.dropEffect=a.ctrlKey?"copy":"move"))}if(!e())return void a.module("ang-drag-drop",[]);var r=a.module("ang-drag-drop",[]);r.directive("uiDraggable",["$parse","$rootScope","$dragImage",function(e,r,t){return function(o,d,i){function f(a){a.originalEvent&&(a.dataTransfer=a.originalEvent.dataTransfer),setTimeout(function(){d.unbind("$destroy",f)},0);var t=i.dragChannel||"defaultchannel";if(r.$broadcast("ANGULAR_DRAG_END",a,t),n(a),a.dataTransfer&&"none"!==a.dataTransfer.dropEffect){if(i.onDropSuccess){var s=e(i.onDropSuccess);o.$evalAsync(function(){s(o,{$event:a})})}}else if(a.dataTransfer&&"none"===a.dataTransfer.dropEffect&&i.onDropFailure){var l=e(i.onDropFailure);o.$evalAsync(function(){l(o,{$event:a})})}d.removeClass(u)}function s(n,r){var t;n.originalEvent&&(n.dataTransfer=n.originalEvent.dataTransfer),t=e(r),o.$apply(function(){var e,r=t(o,{$event:n});r&&a.isString(r)&&(e=document.getElementById(r),e&&n.dataTransfer.setDragImage(e,0,0))})}function l(n){n.originalEvent&&(n.dataTransfer=n.originalEvent.dataTransfer);var l=!c||v.classList.contains(g);if(l){var p=i.dragChannel||"defaultchannel",$="";i.drag&&($=o.$eval(i.drag));var m=i.dragImage||null;d.addClass(u),d.bind("$destroy",f);var T=!(document.uniqueID||window.opera);if(m&&T){var h=e(i.dragImage);o.$apply(function(){var e=h(o,{$event:n});if(e&&(a.isString(e)&&(e=t.generate(e)),e.image)){var r=e.xOffset||0,d=e.yOffset||0;n.dataTransfer.setDragImage(e.image,r,d)}})}else i.dragImageElementId&&s(n,i.dragImageElementId);var D={x:n.offsetX,y:n.offsetY},b={data:$,channel:p,offset:D},y=a.toJson(b);if(n.dataTransfer.setData("application/json",y),n.dataTransfer.effectAllowed="copyMove",i.onDragStart){var A=e(i.onDragStart);o.$evalAsync(function(){A(o,{$event:n})})}r.$broadcast("ANGULAR_DRAG_START",n,p,b)}else n.preventDefault()}var g,v,c=!1,u=i.draggingClass||"on-dragging";d.attr("draggable",!1),o.$watch(i.uiDraggable,function(a){a?(d.attr("draggable",a),d.bind("dragend",f),d.bind("dragstart",l)):(d.removeAttr("draggable"),d.unbind("dragend",f),d.unbind("dragstart",l))}),a.isString(i.dragHandleClass)&&(c=!0,g=i.dragHandleClass.trim()||"drag-handle",d.bind("mousedown",function(a){v=a.target}))}}]),r.directive("uiOnDrop",["$parse","$rootScope",function(e,r){return function(t,o,d){function i(a){for(var e={x:a.offsetX,y:a.offsetY},n=a.target;n!==o[0];)if(e.x=e.x+n.offsetLeft,e.y=e.y+n.offsetTop,n=n.offsetParent,!n)return null;return e}function f(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation();var n=e(d.uiOnDragOver);return t.$evalAsync(function(){n(t,{$event:a,$channel:p})}),!1}function s(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),u--,0===u&&(t.$evalAsync(function(){D(t,{$event:a,$channel:p})}),o.addClass(m),o.removeClass(T));var n=e(d.uiOnDragLeave);t.$evalAsync(function(){n(t,{$event:a,$channel:p})})}function l(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),0===u&&(t.$evalAsync(function(){h(t,{$event:a,$channel:p})}),o.removeClass(m),o.addClass(T)),u++;var n=e(d.uiOnDragEnter);t.$evalAsync(function(){n(t,{$event:a,$channel:p})}),r.$broadcast("ANGULAR_HOVER",$)}function g(r){r.originalEvent&&(r.dataTransfer=r.originalEvent.dataTransfer),r.preventDefault&&r.preventDefault(),r.stopPropagation&&r.stopPropagation();var f=r.dataTransfer.getData("application/json");f=a.fromJson(f);var s=i(r),l=s?{x:s.x-f.offset.x,y:s.y-f.offset.y}:null;n(r);var g=e(d.uiOnDrop);t.$evalAsync(function(){g(t,{$data:f.data,$event:r,$channel:f.channel,$position:l})}),o.removeClass(m),u=0}function v(a,e){if("*"===e)return!0;var n=new RegExp("(\\s|[,])+("+a+")(\\s|[,])+","i");return n.test(","+e+",")}function c(a){return a.originalEvent&&(a.dataTransfer=a.originalEvent.dataTransfer),a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.dataTransfer.dropEffect="none",!1}var u=0,p=d.dropChannel||"defaultchannel",$="",m=d.dragEnterClass||"on-drag-enter",T=d.dragHoverClass||"on-drag-hover",h=e(d.onDragEnter),D=e(d.onDragLeave),b=r.$on("ANGULAR_DRAG_START",function(a,n,r,i){$=r;var u=!0;if(v(r,p)||(u=!1),u&&d.dropValidate){var T=e(d.dropValidate);u=T(t,{$drop:{scope:t,element:o},$event:n,$data:i.data,$channel:i.channel})}u?(o.bind("dragover",f),o.bind("dragenter",l),o.bind("dragleave",s),o.bind("drop",g),o.addClass(m)):(o.bind("dragover",c),o.bind("dragenter",c),o.bind("dragleave",c),o.bind("drop",c),o.removeClass(m))}),y=r.$on("ANGULAR_DRAG_END",function(){o.unbind("dragover",f),o.unbind("dragenter",l),o.unbind("dragleave",s),o.unbind("drop",g),o.removeClass(T),o.removeClass(m),o.unbind("dragover",c),o.unbind("dragenter",c),o.unbind("dragleave",c),o.unbind("drop",c)});t.$on("$destroy",function(){b(),y()}),d.$observe("dropChannel",function(a){a&&(p=a)})}}]),r.constant("$dragImageConfig",{height:20,width:200,padding:10,font:"bold 11px Arial",fontColor:"#eee8d5",backgroundColor:"#93a1a1",xOffset:0,yOffset:0}),r.service("$dragImage",["$dragImageConfig",function(e){function n(a,e,n){var t=a.measureText(e).width;if(t<n.width)return e;for(;t+n.padding>n.width;)e=e.substring(0,e.length-1),t=a.measureText(e+r).width;return e+r}var r="â€¦";this.generate=function(r,t){var o=a.extend({},e,t||{}),d=document.createElement("canvas");d.height=o.height,d.width=o.width;var i=d.getContext("2d");i.fillStyle=o.backgroundColor,i.fillRect(0,0,o.width,o.height),i.font=o.font,i.fillStyle=o.fontColor;var f=n(i,r,o);i.fillText(f,4,o.padding+4);var s=new Image;return s.src=d.toDataURL(),{image:s,xOffset:o.xOffset,yOffset:o.yOffset}}}])}(angular);